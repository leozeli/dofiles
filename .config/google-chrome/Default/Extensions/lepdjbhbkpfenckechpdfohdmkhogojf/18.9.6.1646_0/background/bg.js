"use strict";var bg={init:function(){bgGa.init();var t=new ButGa({trackingId:"UA-117422989-2"});t.pageview(),bgSetting.init();var s,f=this,c=[];"Chrome"===infinity.browser?s="chrome-extension://"+infinity.id+"/option/option.html":"FireFox"===infinity.browser&&(s="moz-extension://"+location.hostname+"/option/option.html"),chrome.browserAction.onClicked.addListener(function(a){var e,o,r;t.event({event:"click",category:"btn",label:"popup"}),o=!(e=function(r){var t={};r.option.packUpTab&&(t.windowId=a.windowId,t.currentWindow=!0),r.option.fixedTab&&(t.pinned=!1),chrome.tabs.query(t,function(t){var i=f.trimData(t,c);if(0!==i.length){var n={name:"Tab_group",time:(new Date).getTime(),windowId:a.windowId,isCurrent:!0,content:i,tid:getTid(r.currentTabs,r.oldTabs)};r.currentTabs.unshift(n),infinity.set("tabs-master",r)}0===c.length?chrome.tabs.create({url:"../option/option.html#/index"}):infinity.sendMessage("tellUpdate",c,function(){});for(var e=f.trimRemove(t,c),o=0;o<e.length;o++)chrome.tabs.remove(e[o].id)})}),r=infinity.get("tabs-master"),chrome.tabs.query({},function(t){for(var i=0;i<t.length;i++)if(-1!==t[i].url.indexOf(s)){-1==c.indexOf(t[i].id)&&c.push(t[i].id),o=!0;break}if(o)e&&e(r);else{c=[];for(var n=r.currentTabs.length-1;0<=n;n--)r.oldTabs.unshift(r.currentTabs[n]);r.currentTabs=[],infinity.set("tabs-master",r),e&&e(r)}})}),infinity.onMessage("getUrl",function(t){for(var a,s,f=t.tab,i=t.tab.content,n=i.length-1;0<=n;n--)if(!i[n].title){s=i[n].url,a=n;break}if(s){var c=new XMLHttpRequest;c.open("get",s,!0),c.onreadystatechange=function(){if(4===c.readyState&&200===c.status){if(!(t=c.response.match(/\<title([\s\S]*)\/title\>/)))return;var t=t[0];if("Chrome"!==infinity.browser){var i=new URL(s);if(CheckImgExists("https://favicon.infinitynewtab.com/"+i.hostname+".png"))var n="https://favicon.infinitynewtab.com/"+i.hostname+".png";else{var e,o=i.hostname.split(".");if(o.shift(),CheckImgExists("https://favicon.infinitynewtab.com/"+(e=o.join("."))+".png"))n="https://favicon.infinitynewtab.com/"+e+".png";else if(o.shift(),CheckImgExists("https://favicon.infinitynewtab.com/"+(e=o.join("."))+".png"))n="https://favicon.infinitynewtab.com/"+e+".png";else n="chrome://favicon/size/18@"+Math.floor(window.devicePixelRatio)+"x/"+s}f.content[a].favIconUrl=n}f.content[a].title=t.split(">")[1].split("<")[0];var r=infinity.get("tabs-master");setTimeout(function(){var t;if(f.isCurrent){var i=!0;t=r.currentTabs;for(var n=0;n<t.length;n++)if(t[n].tid==f.tid){t[n]=f,i=!1;break}if(i){t=r.oldTabs;for(n=0;n<t.length;n++)if(t[n].tid==f.tid){t[n]=f,i=!1;break}}}else{t=r.tabs;for(n=0;n<t.length;n++)if(t[n].tid==f.tid){t[n]=f;break}}infinity.set("tabs-master",r),infinity.sendMessage("getSuccess")},0)}},c.onerror=function(){},c.send()}}),chrome.runtime.onStartup.addListener(function(){var t=infinity.get("tabs-master");t.oldTabs=t.current.concat(t.oldTabs),infinity.set("tabs-master",t),infinity.get("tabs-master").option.follow&&chrome.tabs.create({url:"chrome-extension://"+chrome.runtime.id+"/option/option.html#/index"})}),chrome.runtime.onInstalled.addListener(function(t){if("update"==t.reason){var i=infinity.get("tabs-master");i.tabs.forEach(function(t){"stickTop"in t||(t.stickTop=!1)}),infinity.set("tabs-master",i)}})},trimData:function(t,i){for(var n=[],e=0;e<t.length;e++)if(-1===i.indexOf(t[e].id)&&"chrome://newtab/"!==t[e].url&&-1===t[e].url.indexOf("https://offlintab.firefox")&&-1===t[e].url.indexOf("https://home.firefox")){var o="chrome://favicon/size/18@"+Math.floor(window.devicePixelRatio)+"x/"+t[e].url;if("Chrome"!==infinity.browser){if(CheckImgExists("https://favicon.infinitynewtab.com/"+(o=new URL(t[e].url)).hostname+".png"))var r="https://favicon.infinitynewtab.com/"+o.hostname+".png";else{var a,s=o.hostname.split(".");if(s.shift(),CheckImgExists("https://favicon.infinitynewtab.com/"+(a=s.join("."))+".png"))r="https://favicon.infinitynewtab.com/"+a+".png";else if(s.shift(),CheckImgExists("https://favicon.infinitynewtab.com/"+(a=s.join("."))+".png"))r="https://favicon.infinitynewtab.com/"+a+".png";else r="chrome://favicon/size/18@"+Math.floor(window.devicePixelRatio)+"x/"+t[e].url}o=r}""==t[e].title&&(t[e].title=t[e].url),n.push({favIconUrl:o,title:t[e].title,url:t[e].url,id:t[e].id})}return n},trimRemove:function(t,i){for(var n=[],e=0;e<t.length;e++)-1===i.indexOf(t[e].id)&&n.push({favIconUrl:"chrome://favicon/size/18@"+Math.floor(window.devicePixelRatio)+"x/"+t[e].url,title:t[e].title,url:t[e].url,id:t[e].id});return n}};function CheckImgExists(t){var i;return window.ActiveXObject?i=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(i=new XMLHttpRequest),i.open("Get",t,!1),i.send(),404!=i.status}function tabMasterUrl(i){if("Chrome"===infinity.browser)var t="chrome-extension://"+infinity.id+"/option/option.html";else if("FireFox"===infinity.browser)t="moz-extension://"+infinity.id+"/option/option.html";chrome.tabs.query({url:t},function(t){i&&i(t)})}function getTid(t,i){for(var n=100,e=0;e<t.length;e++){var o=parseInt(t[e].tid);n=n<o?o:n}for(var r=0;r<i.length;r++){var a=parseInt(i[r].tid);n=n<a?a:n}return++n}bg.init();