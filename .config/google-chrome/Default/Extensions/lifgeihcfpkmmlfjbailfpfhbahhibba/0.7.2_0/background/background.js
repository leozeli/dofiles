(function(){"use strict";function h(e,t){if(!e)throw new Error(t||"assertion failed")}const d=typeof location!="undefined"&&location.search.includes("st-debug=1");typeof location!="undefined"&&location.origin==="http://localhost:3000"&&(typeof chrome!="undefined"&&(chrome==null||chrome.storage));const A="https://smarttoc.cc/api",g=e=>{const t=()=>{};return t.basePath=e,new Proxy(t,{get(s,r){if(typeof r!="string"&&typeof r!="number")throw new TypeError("expects string or number");return g(`${s.basePath}/${r}`)},apply(s,r,[o]){return fetch(s.basePath,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(n=>{if(!n.ok||n.status>299)throw new Error(`${n.status} ${n.statusText}`);return n.json()}).catch(n=>{throw n&&n.response?n.response:n})}})},u=g(A),I="smart-toc-pro",E={queryStartTrial(e){return e==null?void 0:e.startTrialReason},async startTrial(e){const t=await this.fetchProductInfo(e);return h(e),h(t.product),await u.customer.startTrial({email:e,productId:t.product.id})},getPrivilegeType(e){return e?e.privilege:{type:"free"}},queryClaimPaid(e){return e==null?void 0:e.claimPaidReason},async claimPaid(e,t){const s=await this.fetchProductInfo(e);return h(s.product),await u.customer.claimPaid({email:e,productId:s.product.id,method:t})},async fetchProductInfo(e){return await u.customer.getProductInfo({email:e,productId:I})}};class D{constructor(){this.disposers=[],this.isDisposed=!1,this.R=t=>(h(!this.isDisposed,"trying to R() after dispose"),this.disposers.push(t),t),this.dispose=()=>{if(this.isDisposed){d&&console.warn("[smarttoc] trying to dispose() after dispose");return}this.isDisposed=!0,this.disposers.reverse().forEach(t=>{typeof t=="function"?t():t.dispose()}),this.disposers=[]}}}class T extends D{constructor(){super(),this.handlerMap=new Map,this.R(()=>this.offAll())}on(t,s){let r=this.handlerMap.get(t)||new Set;return r.add(s),this.handlerMap.set(t,r),()=>this.off(t,s)}off(t,s){let r=this.handlerMap.get(t)||new Set;r.delete(s),this.handlerMap.set(t,r)}emit(t,s){const r=this.handlerMap.get(t);if(r)for(const o of r)o(s)}offAll(){this.handlerMap=new Map}}const l=e=>{let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t},f=(e,t,s)=>typeof s=="number"?s%(t-e+1)+e:Math.floor(Math.random()*(t-e+1))+e,M=()=>{},v=e=>{const t=f(0,360,l("r"+e)),s=f(50,100,l("g"+e)),r=f(60,80,l("b"+e));return`hsl(${t}deg ${s}% ${r}%)`},m=e=>{if(!d)return M;const t=v(e);return(...s)=>{console.info("%c"+e,`color: ${t}`,...s)}},x=m("storage");class L extends T{constructor(t){super(),this.cached={},this.onChange=async()=>{await this.get(),this.emit("changed",void 0)},chrome.storage.onChanged.addListener(this.onChange),d&&typeof globalThis!="undefined"&&(globalThis.__store=this),this.R(()=>chrome.storage.onChanged.removeListener(this.onChange))}async get(){const t=await new Promise((s,r)=>{chrome.storage.sync.get(s)});return x(t),this.cached=t,t}getCached(){return this.cached}async patch(t){const s=Object.keys(t).filter(r=>t[r]==null);await new Promise((r,o)=>{chrome.storage.sync.set(t,r)}),s.length&&await new Promise((r,o)=>{chrome.storage.sync.remove(s,r)}),await this.get()}async DEBUG_reset(){await new Promise((t,s)=>{chrome.storage.sync.clear(t)}),await this.get()}}const i=m("check"),w={permissions:["identity","identity.email"]},y=async()=>await new Promise(e=>chrome.permissions.contains(w,e)),j=async()=>await new Promise(e=>chrome.permissions.request(w,e)),C=async()=>{if(!!await y())return new Promise((t,s)=>{chrome.identity.getProfileUserInfo(r=>{r!=null&&r.email?t(r):t(void 0)})})},$=async()=>{var t;const e=(await a.get()).startCheck;try{const s=await C(),r=await E.fetchProductInfo(s==null?void 0:s.email);await a.patch({productInfo:r}),await a.patch({startCheck:{lastCheckAt:Date.now(),lastCheckSuccess:!0,lastSuccessAt:Date.now(),failedCount:0}}),i("check success")}catch(s){i("check failed",s);const r=(t=e==null?void 0:e.failedCount)!=null?t:0;await a.patch({startCheck:{lastCheckAt:Date.now(),lastCheckSuccess:!1,lastSuccessAt:e==null?void 0:e.lastSuccessAt,failedCount:r+1}})}},S=1e3*60*60*24,F=async()=>{var n;const e=await a.get();let t=!1;{const{productInfo:c}=e;c&&(c.orderStatus?c.orderStatus==="pending"&&(t=!0):c.trialExpireAt&&c.trialExpireAt>=Date.now()&&(t=!0))}const{startCheck:s}=e,r=(Date.now()-((n=s==null?void 0:s.lastCheckAt)!=null?n:-1/0))/S;return s!=null&&s.lastCheckSuccess?r>(t?.3:5):r>(t?.3:1)},a=new L({}),P=async()=>{var e;await F()?(i("checking..."),await $()):i("skip checking");{const t=await a.get();if(t.startCheck){const s=Date.now()-((e=t.startCheck.lastSuccessAt)!=null?e:-1/0);t.startCheck.failedCount>=3&&s>S*3&&(i("reseting state"),await a.patch({productInfo:void 0}))}}},O=()=>{const e=async s=>{const[r]=await chrome.tabs.query({active:!0,currentWindow:!0}),o=r.id;if(!o)return;const n="content/style.css",c="content/content.js";chrome.tabs.sendMessage(o,s,async p=>{var b,k;p===void 0&&((b=chrome.scripting)!=null&&b.insertCSS?await chrome.scripting.insertCSS({target:{tabId:o,allFrames:!0},files:[n]}):await chrome.tabs.insertCSS(o,{file:n,allFrames:!0}),(k=chrome.scripting)!=null&&k.executeScript?await chrome.scripting.executeScript({target:{tabId:o,allFrames:!0},files:[c]}):await chrome.tabs.executeScript(o,{file:c,allFrames:!0}))})};(chrome.action||chrome.browserAction).onClicked.addListener(()=>e("toggle")),chrome.commands.onCommand.addListener(s=>e(s))};function R(e){return chrome.runtime.onMessage.addListener((t,s,r)=>((async()=>{try{const{command:o,args:n}=t,c=e[o];if(typeof c!="function")throw new Error("handler not found for command: "+o);const p=await c(...n);r({ok:!0,result:p})}catch(o){r({ok:!1,error:o})}})(),!0)),e}const _=async()=>{O(),await P()};R({hasIdentityPermission:y,requestIdentityPermission:j,getBrowserAccount:C,checkProductStatusIfNeeded:P,async openOptionsPage(){return console.log("open"),new Promise((e,t)=>{chrome.runtime.openOptionsPage(()=>{console.log("open done"),chrome.runtime.lastError?t(chrome.runtime.lastError):e()})})}}),_().catch(e=>{console.error(e)})})();
